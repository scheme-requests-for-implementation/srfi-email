<!-- MHonArc v2.6.15 -->
<!--X-Subject: Re: Specification vs. Implementation -->
<!--X-From-R13: Bre Pbguare <creNobguare.pbz> -->
<!--X-Date: Mon, 29 Aug 2005 21:23:26 +0200 (MST) -->
<!--X-Message-Id: 4313609F.5090108@bothner.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 5fb7e0870508221948311ded7f@mail.gmail.com -->
<!--X-Reference: y9loe7pnmiw.fsf@sams.informatik.uni&#45;tuebingen.de -->
<!--X-Reference: 5fb7e0870508231948c0506fa@mail.gmail.com -->
<!--X-Reference: y9lbr3njkjf.fsf@sams.informatik.uni&#45;tuebingen.de -->
<!--X-Reference: 5fb7e08705082418335a20cdf8@mail.gmail.com -->
<!--X-Reference: y9lslwyc6en.fsf@sams.informatik.uni&#45;tuebingen.de -->
<!--X-Reference: 5fb7e0870508251834683254fc@mail.gmail.com -->
<!--X-Reference: y9lacj4bmlf.fsf@sams.informatik.uni&#45;tuebingen.de -->
<!--X-Reference: 430F6EBF.4000908@bothner.com -->
<!--X-Reference: y9lslwu9iib.fsf@sams.informatik.uni&#45;tuebingen.de -->
<!--X-Reference: 4311F914.1010302@bothner.com -->
<!--X-Reference: y9lek8cy7ie.fsf@sams.informatik.uni&#45;tuebingen.de -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Specification vs. Implementation</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00111.html">Date Prev</a>][<a href="msg00113.html">Date Next</a>][<a href="msg00110.html">Thread Prev</a>][<a href="msg00109.html">Thread Next</a>][<a href="maillist.html#00112">Date Index</a>][<a href="threads.html#00112">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: Specification vs. Implementation</h1>
<p style="max-width: 30em;">This page is part of the web mail archives of <a href="http://srfi.schemers.org/srfi-68">SRFI 68</a> from before July 7th, 2015.  The new archives for SRFI 68 are <a href="http://srfi-email.schemers.org/srfi-68/">here</a>.  The new archives contain all messages, not just those from before July 7th, 2015.</p>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Michael Sperber &lt;<a href="mailto:sperber@DOMAIN.HIDDEN">sperber@xxxxxxxxxxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>Subject</em>: Re: Specification vs. Implementation</li>
<li><em>From</em>: Per Bothner &lt;<a href="mailto:per@DOMAIN.HIDDEN">per@xxxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Mon, 29 Aug 2005 12:23:11 -0700</li>
<li><em>Cc</em>: <a href="mailto:srfi-68@DOMAIN.HIDDEN">srfi-68@xxxxxxxxxxxxxxxxx</a></li>
<li><em>Delivered-to</em>: <a href="mailto:srfi-68@DOMAIN.HIDDEN">srfi-68@xxxxxxxxxxxxxxxxx</a></li>
<li><em>In-reply-to</em>: &lt;<a href="mailto:y9lek8cy7ie.fsf@DOMAIN.HIDDEN">y9lek8cy7ie.fsf@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>References</em>: &lt;<a href="mailto:5fb7e0870508221948311ded7f@DOMAIN.HIDDEN">5fb7e0870508221948311ded7f@xxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:y9loe7pnmiw.fsf@DOMAIN.HIDDEN">y9loe7pnmiw.fsf@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:5fb7e0870508231948c0506fa@DOMAIN.HIDDEN">5fb7e0870508231948c0506fa@xxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:y9lbr3njkjf.fsf@DOMAIN.HIDDEN">y9lbr3njkjf.fsf@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:5fb7e08705082418335a20cdf8@DOMAIN.HIDDEN">5fb7e08705082418335a20cdf8@xxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:y9lslwyc6en.fsf@DOMAIN.HIDDEN">y9lslwyc6en.fsf@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:5fb7e0870508251834683254fc@DOMAIN.HIDDEN">5fb7e0870508251834683254fc@xxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:y9lacj4bmlf.fsf@DOMAIN.HIDDEN">y9lacj4bmlf.fsf@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:430F6EBF.4000908@DOMAIN.HIDDEN">430F6EBF.4000908@xxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:y9lslwu9iib.fsf@DOMAIN.HIDDEN">y9lslwu9iib.fsf@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</a>&gt;	&lt;<a href="mailto:4311F914.1010302@DOMAIN.HIDDEN">4311F914.1010302@xxxxxxxxxxx</a>&gt; &lt;<a href="mailto:y9lek8cy7ie.fsf@DOMAIN.HIDDEN">y9lek8cy7ie.fsf@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>User-agent</em>: Mozilla Thunderbird 1.0.6-1.1.fc4 (X11/20050720)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Michael Sperber wrote:
&gt; Per Bothner &lt;per@xxxxxxxxxxx&gt; writes:
&gt;
&gt;
&gt;&gt;I don't buy this at all.  Why can't I replace:
&gt;&gt;  (make-simple-reader id descriptor etc ...)
&gt;&gt;by
&gt;&gt;  (make-simple-input-port id descriptor etc ...)
&gt;&gt;I.e. why can't I merge the functionality of readers into
&gt;&gt;input-ports?
&gt;
&gt;
&gt; You could do that, but you'd have eliminated only one procedure call.
&gt; Moreover, it's unclear to me what you've gained.

You may be missing my point.  The &quot;make-simple-input-port&quot; function
wouldn't call make-simple-reader because there would be no simple
reader type anymore.  The input-port would be an object with the
necessary &quot;methods&quot;.  What we're gaining is removing an extra level of
indirection and layering for *all* operations.

&gt; It still wouldn't make the primitive layer obsolete.

I think it would.  The point is there is no need for a separate
primitive layer.  At least I haven't seen such a need, and there are
good reasons for avoiding it, primarily simplicity, both in API and
implementation.  The latter can allow better performance.

&gt; You've stated that you think you can get their performance, and lack
&gt; of buffering from the ports layer, but you haven't demonstrated how to
&gt; do it---it's certainly not straightforward, given the buffering
&gt; inherent in things like PEEK-CHAR.

Agreed.  If character operations are performed, then we require at
least some buffering.  And we can't just use the system block-boundary
buffers, since characters can straddle block boundaries.

&gt; It'll take a concrete proposal to convince me to change the layout.

Here are some preliminary thoughts.

In pre-JDK-1.4 Java (i.e. without direct access to the translation API)
you'd still need multiple layers (i.e. a separate Reader for chars
and an InputStream for bytes) but the layers would be driven by
implementation considerations, and not constrained by the Scheme API.
I.e. an input-port might be an object that has both an InputStream
and a Reader.

I think we should specifrequire only these modes:
* A program can arbitrarily switch back and forth between bytes amd
UTF-8 or Latin-1 chars.  In that case the Scheme &quot;ports&quot; can do the
conversion directly without depending on external conversion APIs.

Such a port would basically be a binary port with a byte buffer (a
blob).  (An unbuffered port still has a one-byte buffer.)  The
current position is a byte position, indicated by an offset into
the blob.  Reading bytes is obvious; reading also more-or-less so.
Handling peek-char is trickier if the blob only contains a
partial character.  We can implement this using an extra short buffer,
which can be represented by a fixnum field.  We can also use negative
blob indexes for when the current position is in the short buffer.

Suppose the current position is before the last byte in the buffer,
and that byte is the first byte of a multi-byte character.
peek-char gets the byte, fills the buffer, and looks at enough
bytes in the new &quot;block&quot; to determine the character.  It saves
the byte from the previous block in the short buffer, and notes
that the offset in the current block is -1 - i.e. one byte *before*
the start of the current block.  A subsequent read or peek operation
notes this negative offset, and gets the data from the short buffer.

Java input streams have a read-ahead mehanism, where you can mark
a position, read ahead, and then reset back to the mark.  This is
a useful feature for lexers/parsers.  It makes sense to combine
support this read-ahead support with that needed for peek-char.
I.e. instead of a &quot;short buffer&quot; you have an extra buffer &quot;save buffer&quot;.

So I'd recommend using two buffers: the &quot;system buffer&quot; is block-sized,
propertly aligned, etc, for actual I/O.  The system buffer is missing
(i.e. zero bytes long) for unbuffered files.  In addition, there is a
&quot;save buffer&quot; which is normally just a few bytes, but can grow
arbitrarily large, if we allow arbitrary look-ahead.  Conceptually, we
have a single buffer, consisting of the concatenation of the save
buffer and the system buffer.  (An implementation can use a single
buffer, but that will normally be less efficient.)  The current
position is an offset, where non-negative values point into the system
buffer, and negative values point into the save buffer.  The position
can always be reset to any point between the start of the save buffer
and the current position.  A peek is then a &quot;mark current position as
a save-point&quot;, read-ahead, and then revert back to the saved position.
Relatively simple, efficient, and general.

Output ports don't have the same complications.  (They may have
other complications, such as pretty-printing and handling cycles,
but mixing binary and text in different encodings is at least
conceptually straight-forward.)

* A program can switch from reading/writing bytes to reading/writing
chars in an abitrary support encoding, but cannot necessarily switch
back, or switch to a different encoding, unless the encoding is UTF-8
or Latin-1.  In that case the implementation can layer a
implementation character stream on top of an implementation byte
stream.  This is fairly straightforward in Java, but some
implementations have have difficulty if there have been any byte
operations before the first char operations.  So it should be
permissible for an implementation to not support *any* byte/char mixing
(except for UTF-8 and Latin-1).
--
	--Per Bothner
per@xxxxxxxxxxx   <a  rel="nofollow" href="http://per.bothner.com/">http://per.bothner.com/</a>

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00063" href="msg00063.html">Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Alex Shinn</li></ul></li>
<li><strong><a name="00065" href="msg00065.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Michael Sperber</li></ul></li>
<li><strong><a name="00068" href="msg00068.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Alex Shinn</li></ul></li>
<li><strong><a name="00078" href="msg00078.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Michael Sperber</li></ul></li>
<li><strong><a name="00084" href="msg00084.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Alex Shinn</li></ul></li>
<li><strong><a name="00088" href="msg00088.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Michael Sperber</li></ul></li>
<li><strong><a name="00095" href="msg00095.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Alex Shinn</li></ul></li>
<li><strong><a name="00098" href="msg00098.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Michael Sperber</li></ul></li>
<li><strong><a name="00100" href="msg00100.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Per Bothner</li></ul></li>
<li><strong><a name="00103" href="msg00103.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Michael Sperber</li></ul></li>
<li><strong><a name="00106" href="msg00106.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Per Bothner</li></ul></li>
<li><strong><a name="00110" href="msg00110.html">Re: Specification vs. Implementation</a></strong>
<ul><li><em>From:</em> Michael Sperber</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00111.html">Re: Specification vs. Implementation</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00113.html">Re: Mixing characters and bytes</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00110.html">Re: Specification vs. Implementation</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00109.html">Re: Specification vs. Implementation</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00112"><strong>Date</strong></a></li>
<li><a href="threads.html#00112"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
